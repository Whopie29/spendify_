<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPENDIFY - Interactive Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: 400px;
        }
        .transaction-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .transaction-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        .filter-controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .transaction-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="text-center mb-4">
            <h1>üìä SPENDIFY Interactive Dashboard</h1>
            <h4>{{ data.bank_name }}</h4>
        </div>

        <!-- Stats Cards -->
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <h3>‚Çπ{{ "{:,.0f}".format(data.total_withdrawals) }}</h3>
                    <p>Total Withdrawals</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h3>‚Çπ{{ "{:,.0f}".format(data.total_deposits) }}</h3>
                    <p>Total Deposits</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h3>‚Çπ{{ "{:,.0f}".format(data.current_balance) }}</h3>
                    <p>Current Balance</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <h3>{{ data.transaction_count }}</h3>
                    <p>Total Transactions</p>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Category Distribution</h5>
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Monthly Trends</h5>
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
            <h5>Filter Transactions</h5>
            <div class="row g-2">
                <div class="col-lg-3 col-md-6">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search transactions...">
                </div>
                <div class="col-lg-2 col-md-6">
                    <select id="categoryFilter" class="form-select">
                        <option value="">All Categories</option>
                        {% for category in data.categories.keys() %}
                        <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-lg-2 col-md-4">
                    <input type="number" id="minAmount" class="form-control" placeholder="Min Amount">
                </div>
                <div class="col-lg-2 col-md-4">
                    <input type="number" id="maxAmount" class="form-control" placeholder="Max Amount">
                </div>
                <div class="col-lg-3 col-md-4">
                    <div class="d-flex gap-1">
                        <button class="btn btn-custom flex-fill" onclick="applyFilters()">Filter</button>
                        <button class="btn btn-outline-secondary flex-fill" onclick="clearFilters()">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Transactions -->
        <div class="chart-container" style="height: 650px; display: flex; flex-direction: column;">
            <h5 style="margin-bottom: 15px;">All Transactions ({{ data.transaction_count }} total)</h5>
            <div style="flex: 1; overflow: hidden; border: 1px solid #dee2e6; border-radius: 5px;">
                <div style="height: 100%; overflow-y: auto;">
                    <table class="table table-striped table-hover mb-0" style="table-layout: fixed; width: 100%;">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th style="width: 15%;">Date</th>
                                <th style="width: 35%;">Description</th>
                                <th style="width: 17%;">Withdrawal</th>
                                <th style="width: 17%;">Deposit</th>
                                <th style="width: 16%;">Category</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsList">
                            {% for transaction in data.all_transactions %}
                            <tr class="transaction-item" data-category="{{ transaction.Category }}" data-amount="{{ transaction['Withdrawal Amount'] or transaction['Deposit Amount'] }}">
                                <td style="text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><small>{{ transaction.Date }}</small></td>
                                <td style="text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ transaction.Narration }}</td>
                                <td style="text-align: right;">
                                    {% if transaction['Withdrawal Amount'] > 0 %}
                                        <span class="text-danger">‚Çπ{{ "{:,.0f}".format(transaction['Withdrawal Amount']) }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td style="text-align: right;">
                                    {% if transaction['Deposit Amount'] > 0 %}
                                        <span class="text-success">‚Çπ{{ "{:,.0f}".format(transaction['Deposit Amount']) }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td style="text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><span class="badge bg-secondary">{{ transaction.Category }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mt-4 mb-4">
            <a href="/analysis" class="btn btn-outline-secondary px-4">‚Üê Back to Analysis</a>
        </div>
    </div>

    <script>
        // Category Chart
        const categoryData = {{ data.categories | tojson }};
        const ctx1 = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: Object.keys(categoryData),
                datasets: [{
                    data: Object.values(categoryData),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                        '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', 
                        '#4BC0C0', '#FF6384'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Monthly Chart
        const monthlyData = {{ data.monthly_data | tojson }};
        const ctx2 = document.getElementById('monthlyChart').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: monthlyData.map(d => d.Month),
                datasets: [{
                    label: 'Withdrawals',
                    data: monthlyData.map(d => d['Withdrawal Amount']),
                    backgroundColor: '#FF6384'
                }, {
                    label: 'Deposits',
                    data: monthlyData.map(d => d['Deposit Amount']),
                    backgroundColor: '#36A2EB'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Filter functions
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const minAmount = parseFloat(document.getElementById('minAmount').value) || 0;
            const maxAmount = parseFloat(document.getElementById('maxAmount').value) || Infinity;
            
            const transactions = document.querySelectorAll('.transaction-item');
            
            transactions.forEach(transaction => {
                const text = transaction.textContent.toLowerCase();
                const category = transaction.dataset.category;
                const amount = parseFloat(transaction.dataset.amount) || 0;
                
                const matchesSearch = text.includes(searchTerm);
                const matchesCategory = !categoryFilter || category === categoryFilter;
                const matchesAmount = amount >= minAmount && amount <= maxAmount;
                
                transaction.style.display = matchesSearch && matchesCategory && matchesAmount ? '' : 'none';
            });
        }
        
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('minAmount').value = '';
            document.getElementById('maxAmount').value = '';
            
            document.querySelectorAll('.transaction-item').forEach(transaction => {
                transaction.style.display = '';
            });
        }

        // Real-time search
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    </script>
</body>
</html>